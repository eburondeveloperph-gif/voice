{"version":3,"sources":["../../../src/lib/ev/backup.ts","../../../src/lib/defaultAgent.ts","../../../src/lib/ev/vapi-client.ts","../../../src/lib/ev/calls.ts","../../../src/lib/crm/api.ts","../../../src/lib/crm/access.ts","../../../src/lib/crm/http.ts","../../../src/lib/crm/agent-scope.ts","../../../node_modules/next/dist/esm/build/templates/app-route.js","../../../src/app/api/crm/%5BclientSlug%5D/calls/route.ts"],"sourcesContent":["/**\n * Supabase Backup – fire-and-forget sync layer.\n *\n * Every function catches its own errors so a Supabase outage never\n * interrupts the primary SQLite + Vapi flow.\n *\n * Supabase tables expected (create via Supabase dashboard / SQL editor):\n *\n *   orgs            (id, name, slug, created_at, updated_at)\n *   agents          (id, org_id, name, intro, system_prompt, voice_id,\n *                    vapi_assistant_id, status, deployed_at, created_at, updated_at)\n *   call_logs       (id, org_id, agent_id, vapi_call_id, from_number, to_number,\n *                    started_at, ended_at, duration_seconds, cost_usd, status,\n *                    direction, transcript, recording_url, metadata, source,\n *                    created_at, updated_at)\n *   voice_catalog   (id, label, locale, upstream_provider, upstream_voice_id,\n *                    preview_sample_url, is_approved, sort_order, created_at, updated_at)\n *   contacts        (id, org_id, full_name, phone_number, email, tags,\n *                    created_at, updated_at)\n *   crm_projects    (id, org_id, created_by_id, name, slug, custom_domain,\n *                    description, allowed_emails, logo_url, is_active,\n *                    created_at, updated_at)\n *   crm_leads       (id, org_id, project_id, full_name, email, phone, company,\n *                    stage, source, owner_email, notes, metadata,\n *                    created_at, updated_at)\n *   crm_activities  (id, org_id, project_id, lead_id, type, summary, metadata,\n *                    created_by_email, created_at)\n *   crm_files       (id, org_id, project_id, lead_id, file_name, content_type,\n *                    size_bytes, storage_path, public_url, uploaded_by_email,\n *                    created_at)\n */\n\nimport { getSupabaseAdminClient } from \"@/lib/supabase-server\";\nimport { prisma } from \"@/lib/db\";\n\n// ─── helpers ────────────────────────────────────────────────────────\n\nfunction warn(label: string, err: unknown): void {\n    console.warn(`[supabase-backup] ${label}:`, err instanceof Error ? err.message : err);\n}\n\n// ─── individual entity backups ──────────────────────────────────────\n\nexport async function backupOrg(org: {\n    id: string;\n    name: string;\n    slug: string;\n    createdAt: Date;\n    updatedAt: Date;\n}): Promise<void> {\n    try {\n        const sb = getSupabaseAdminClient();\n        if (!sb) return;\n\n        await sb.from(\"orgs\").upsert(\n            {\n                id: org.id,\n                name: org.name,\n                slug: org.slug,\n                created_at: org.createdAt.toISOString(),\n                updated_at: org.updatedAt.toISOString(),\n            },\n            { onConflict: \"id\" },\n        );\n    } catch (err) {\n        warn(\"backupOrg\", err);\n    }\n}\n\nexport async function backupAgent(agent: {\n    id: string;\n    orgId: string;\n    name: string;\n    intro: string;\n    systemPrompt: string;\n    voiceId: string;\n    vapiAssistantId?: string | null;\n    status: string;\n    deployedAt?: Date | null;\n    createdAt: Date;\n    updatedAt: Date;\n}): Promise<void> {\n    try {\n        const sb = getSupabaseAdminClient();\n        if (!sb) return;\n\n        await sb.from(\"agents\").upsert(\n            {\n                id: agent.id,\n                org_id: agent.orgId,\n                name: agent.name,\n                intro: agent.intro,\n                system_prompt: agent.systemPrompt,\n                voice_id: agent.voiceId,\n                vapi_assistant_id: agent.vapiAssistantId ?? null,\n                status: agent.status,\n                deployed_at: agent.deployedAt?.toISOString() ?? null,\n                created_at: agent.createdAt.toISOString(),\n                updated_at: agent.updatedAt.toISOString(),\n            },\n            { onConflict: \"id\" },\n        );\n    } catch (err) {\n        warn(\"backupAgent\", err);\n    }\n}\n\nexport async function backupCallLog(callLog: {\n    id: string;\n    orgId: string;\n    agentId?: string | null;\n    vapiCallId: string;\n    fromNumber?: string | null;\n    toNumber?: string | null;\n    startedAt?: Date | null;\n    endedAt?: Date | null;\n    durationSeconds?: number | null;\n    costUsd?: number | null;\n    status: string;\n    direction?: string | null;\n    transcript?: unknown;\n    recordingUrl?: string | null;\n    metadata?: unknown;\n    source: string;\n    createdAt: Date;\n    updatedAt: Date;\n}): Promise<void> {\n    try {\n        const sb = getSupabaseAdminClient();\n        if (!sb) return;\n\n        await sb.from(\"call_logs\").upsert(\n            {\n                id: callLog.id,\n                org_id: callLog.orgId,\n                agent_id: callLog.agentId ?? null,\n                vapi_call_id: callLog.vapiCallId,\n                from_number: callLog.fromNumber ?? null,\n                to_number: callLog.toNumber ?? null,\n                started_at: callLog.startedAt?.toISOString() ?? null,\n                ended_at: callLog.endedAt?.toISOString() ?? null,\n                duration_seconds: callLog.durationSeconds ?? null,\n                cost_usd: callLog.costUsd ?? null,\n                status: callLog.status,\n                direction: callLog.direction ?? null,\n                transcript: callLog.transcript ?? null,\n                recording_url: callLog.recordingUrl ?? null,\n                metadata: callLog.metadata ?? null,\n                source: callLog.source,\n                created_at: callLog.createdAt.toISOString(),\n                updated_at: callLog.updatedAt.toISOString(),\n            },\n            { onConflict: \"id\" },\n        );\n    } catch (err) {\n        warn(\"backupCallLog\", err);\n    }\n}\n\nexport async function backupVoice(voice: {\n    id: string;\n    label: string;\n    locale: string;\n    upstreamProvider: string;\n    upstreamVoiceId: string;\n    previewSampleUrl?: string | null;\n    isApproved: boolean;\n    sortOrder: number;\n    createdAt: Date;\n    updatedAt: Date;\n}): Promise<void> {\n    try {\n        const sb = getSupabaseAdminClient();\n        if (!sb) return;\n\n        await sb.from(\"voice_catalog\").upsert(\n            {\n                id: voice.id,\n                label: voice.label,\n                locale: voice.locale,\n                upstream_provider: voice.upstreamProvider,\n                upstream_voice_id: voice.upstreamVoiceId,\n                preview_sample_url: voice.previewSampleUrl ?? null,\n                is_approved: voice.isApproved,\n                sort_order: voice.sortOrder,\n                created_at: voice.createdAt.toISOString(),\n                updated_at: voice.updatedAt.toISOString(),\n            },\n            { onConflict: \"id\" },\n        );\n    } catch (err) {\n        warn(\"backupVoice\", err);\n    }\n}\n\nexport async function backupContact(contact: {\n    id: string;\n    orgId: string;\n    fullName: string;\n    phoneNumber: string;\n    email?: string | null;\n    tags?: string | null;\n    createdAt: Date;\n    updatedAt: Date;\n}): Promise<void> {\n    try {\n        const sb = getSupabaseAdminClient();\n        if (!sb) return;\n\n        await sb.from(\"contacts\").upsert(\n            {\n                id: contact.id,\n                org_id: contact.orgId,\n                full_name: contact.fullName,\n                phone_number: contact.phoneNumber,\n                email: contact.email ?? null,\n                tags: contact.tags ?? null,\n                created_at: contact.createdAt.toISOString(),\n                updated_at: contact.updatedAt.toISOString(),\n            },\n            { onConflict: \"id\" },\n        );\n    } catch (err) {\n        warn(\"backupContact\", err);\n    }\n}\n\nexport async function backupCrmProject(project: {\n    id: string;\n    orgId: string;\n    createdById?: string | null;\n    name: string;\n    slug: string;\n    customDomain?: string | null;\n    description?: string | null;\n    allowedEmails?: string | null;\n    logoUrl?: string | null;\n    isActive: boolean;\n    createdAt: Date;\n    updatedAt: Date;\n}): Promise<void> {\n    try {\n        const sb = getSupabaseAdminClient();\n        if (!sb) return;\n\n        await sb.from(\"crm_projects\").upsert(\n            {\n                id: project.id,\n                org_id: project.orgId,\n                created_by_id: project.createdById ?? null,\n                name: project.name,\n                slug: project.slug,\n                custom_domain: project.customDomain ?? null,\n                description: project.description ?? null,\n                allowed_emails: project.allowedEmails ?? null,\n                logo_url: project.logoUrl ?? null,\n                is_active: project.isActive,\n                created_at: project.createdAt.toISOString(),\n                updated_at: project.updatedAt.toISOString(),\n            },\n            { onConflict: \"id\" },\n        );\n    } catch (err) {\n        warn(\"backupCrmProject\", err);\n    }\n}\n\nexport async function backupCrmLead(lead: {\n    id: string;\n    orgId: string;\n    projectId: string;\n    fullName: string;\n    email?: string | null;\n    phone?: string | null;\n    company?: string | null;\n    stage: string;\n    source?: string | null;\n    ownerEmail?: string | null;\n    notes?: string | null;\n    metadata?: unknown;\n    createdAt: Date;\n    updatedAt: Date;\n}): Promise<void> {\n    try {\n        const sb = getSupabaseAdminClient();\n        if (!sb) return;\n\n        await sb.from(\"crm_leads\").upsert(\n            {\n                id: lead.id,\n                org_id: lead.orgId,\n                project_id: lead.projectId,\n                full_name: lead.fullName,\n                email: lead.email ?? null,\n                phone: lead.phone ?? null,\n                company: lead.company ?? null,\n                stage: lead.stage,\n                source: lead.source ?? null,\n                owner_email: lead.ownerEmail ?? null,\n                notes: lead.notes ?? null,\n                metadata: lead.metadata ?? null,\n                created_at: lead.createdAt.toISOString(),\n                updated_at: lead.updatedAt.toISOString(),\n            },\n            { onConflict: \"id\" },\n        );\n    } catch (err) {\n        warn(\"backupCrmLead\", err);\n    }\n}\n\nexport async function backupCrmActivity(activity: {\n    id: string;\n    orgId: string;\n    projectId: string;\n    leadId?: string | null;\n    type: string;\n    summary: string;\n    metadata?: unknown;\n    createdByEmail?: string | null;\n    createdAt: Date;\n}): Promise<void> {\n    try {\n        const sb = getSupabaseAdminClient();\n        if (!sb) return;\n\n        await sb.from(\"crm_activities\").upsert(\n            {\n                id: activity.id,\n                org_id: activity.orgId,\n                project_id: activity.projectId,\n                lead_id: activity.leadId ?? null,\n                type: activity.type,\n                summary: activity.summary,\n                metadata: activity.metadata ?? null,\n                created_by_email: activity.createdByEmail ?? null,\n                created_at: activity.createdAt.toISOString(),\n            },\n            { onConflict: \"id\" },\n        );\n    } catch (err) {\n        warn(\"backupCrmActivity\", err);\n    }\n}\n\nexport async function backupCrmFile(file: {\n    id: string;\n    orgId: string;\n    projectId: string;\n    leadId?: string | null;\n    fileName: string;\n    contentType?: string | null;\n    sizeBytes: number;\n    storagePath: string;\n    publicUrl?: string | null;\n    uploadedByEmail?: string | null;\n    createdAt: Date;\n}): Promise<void> {\n    try {\n        const sb = getSupabaseAdminClient();\n        if (!sb) return;\n\n        await sb.from(\"crm_files\").upsert(\n            {\n                id: file.id,\n                org_id: file.orgId,\n                project_id: file.projectId,\n                lead_id: file.leadId ?? null,\n                file_name: file.fileName,\n                content_type: file.contentType ?? null,\n                size_bytes: file.sizeBytes,\n                storage_path: file.storagePath,\n                public_url: file.publicUrl ?? null,\n                uploaded_by_email: file.uploadedByEmail ?? null,\n                created_at: file.createdAt.toISOString(),\n            },\n            { onConflict: \"id\" },\n        );\n    } catch (err) {\n        warn(\"backupCrmFile\", err);\n    }\n}\n\n// ─── bulk sync — push everything from Prisma to Supabase ────────────\n\nexport async function backupAll(): Promise<{\n    orgs: number;\n    agents: number;\n    callLogs: number;\n    voices: number;\n    contacts: number;\n    crmProjects: number;\n    crmLeads: number;\n    crmActivities: number;\n    crmFiles: number;\n}> {\n    const counts = {\n        orgs: 0,\n        agents: 0,\n        callLogs: 0,\n        voices: 0,\n        contacts: 0,\n        crmProjects: 0,\n        crmLeads: 0,\n        crmActivities: 0,\n        crmFiles: 0,\n    };\n\n    const sb = getSupabaseAdminClient();\n    if (!sb) return counts;\n\n    try {\n        const orgs = await prisma.org.findMany();\n        for (const org of orgs) {\n            await backupOrg(org);\n            counts.orgs++;\n        }\n\n        const agents = await prisma.agent.findMany();\n        for (const agent of agents) {\n            await backupAgent(agent);\n            counts.agents++;\n        }\n\n        const callLogs = await prisma.callLog.findMany();\n        for (const log of callLogs) {\n            await backupCallLog(log);\n            counts.callLogs++;\n        }\n\n        const voices = await prisma.voiceCatalog.findMany();\n        for (const voice of voices) {\n            await backupVoice(voice);\n            counts.voices++;\n        }\n\n        const contacts = await prisma.contact.findMany();\n        for (const contact of contacts) {\n            await backupContact(contact);\n            counts.contacts++;\n        }\n\n        const crmProjects = await prisma.crmProject.findMany();\n        for (const project of crmProjects) {\n            await backupCrmProject(project);\n            counts.crmProjects++;\n        }\n\n        const crmLeads = await prisma.crmLead.findMany();\n        for (const lead of crmLeads) {\n            await backupCrmLead(lead);\n            counts.crmLeads++;\n        }\n\n        const crmActivities = await prisma.crmActivity.findMany();\n        for (const activity of crmActivities) {\n            await backupCrmActivity(activity);\n            counts.crmActivities++;\n        }\n\n        const crmFiles = await prisma.crmFile.findMany();\n        for (const file of crmFiles) {\n            await backupCrmFile(file);\n            counts.crmFiles++;\n        }\n    } catch (err) {\n        warn(\"backupAll\", err);\n    }\n\n    return counts;\n}\n","/**\n * Default Vapi assistant configuration.\n * Used as a fallback when no org-specific agent is configured\n * and when initialising new calls without an explicit assistantId.\n */\n\nexport const DEFAULT_AGENT_ID = \"e32ec77b-bf48-412b-9d2b-857bf089eb8d\";\n\nexport const DEFAULT_AGENT_ORG_ID = \"9497cd9a-d002-40d6-9b66-04fd98855f29\";\n\nexport const DEFAULT_AGENT_PHONE = \"+1 (844) 418 2027\";\nexport const DEFAULT_AGENT_PHONE_ID = \"8ef13ef5-c2b5-43ab-b6c6-cdde03f0ee48\";\n\n/** Full Vapi assistant payload — kept in sync with the upstream record. */\nexport const DEFAULT_AGENT = {\n    id: DEFAULT_AGENT_ID,\n    orgId: DEFAULT_AGENT_ORG_ID,\n    name: \"Stephen\",\n    voice: {\n        voiceId: \"orbit-emma\",\n        provider: \"vapi\",\n    },\n    createdAt: \"2026-02-16T08:30:48.152Z\",\n    updatedAt: \"2026-02-17T13:42:10.923Z\",\n    model: {\n        model: \"gpt-4o-mini\",\n        messages: [\n            {\n                role: \"system\",\n                content: `[Identity]  \nYou are Stephen, a business development voice assistant for Eburon Tech, a B2B software solutions provider. Your primary purpose is to identify qualified leads, understand their business challenges, and connect them with the appropriate sales representatives for solutions that match their needs.\n\n[Voice & Persona]  \n- Sound friendly, consultative, and genuinely interested in the prospect's business.  \n- Convey confidence and expertise without being pushy or aggressive.  \n- Project a helpful, solution-oriented approach rather than a traditional \"sales\" persona.  \n- Balance professionalism with approachable warmth.  \n\n[Speech Characteristics]  \n- Use a conversational business tone with natural contractions (we're, I'd, they've) and integrate natural human nuances like brief laughter, throat clearing, sighs, and correcting yourself with phrases like, \"ahm, I should say...\"  \n- Include thoughtful pauses and sometimes double-read words for emphasis.  \n- Vary your pacing—speak more deliberately when discussing important points.  \n- Employ occasional business phrases naturally (e.g., \"let's circle back to,\" \"drill down on that\").  \n\n[Conversation Flow]  \n\n[Introduction]  \nBegin with: \"Hello, ahm, this is Stephen from Eburon Tech. We help businesses improve their operational efficiency through custom software solutions. Do—um, do you have a few minutes to chat about how we might be able to help your business?\"  \nIf they sound busy or hesitant: \"I understand you're busy. Would it be better if I called at another time? My goal is just to—uh, learn about your business challenges and see if our solutions might fit.\"\n\n[Need Discovery]  \n1. Industry understanding: \"Could you tell me a bit about your business and the industry you operate in?\"  \n2. Current situation: \"What systems or processes are you currently using to manage your [relevant business area]?\"  \n3. Pain points: \"What are the biggest challenges you're facing with your current approach?\"  \n4. Impact: \"Ah, how are these challenges affecting your, um, business operations or bottom line?\"  \n5. Previous solutions: \"Have you tried other solutions to address these challenges? What was your experience?\"\n\n[Solution Alignment]  \n1. Highlight relevant capabilities: \"Based on what you've shared, our [specific solution] could help address your [specific pain point] by [benefit].\"  \n2. Success stories: \"We've worked with several companies in [their industry] with similar challenges. For example, one client was able to [specific result] after implementing our solution.\"  \n3. Differentiation: \"What makes our approach different is [key differentiator].\"\n\n[Qualification Assessment]  \n1. Decision timeline: \"What's your timeline for implementing a solution like this?\"  \n2. Budget exploration: \"Have you allocated budget for improving this area of your business?\"  \n3. Decision process: \"Who else would be involved in evaluating a solution like ours?\"  \n4. Success criteria: \"If you were to implement a new solution, how would you measure its success?\"\n\n[Next Steps]  \n- For qualified prospects: \"Based on our conversation, I think it would be valuable to have you speak with [appropriate sales representative], who specializes in [relevant area]. They can provide a more tailored overview of how we could help with [specific challenges mentioned]. Would you be available for a 30-minute call [suggest specific times]?\"  \n- For prospects needing nurturing: \"It sounds like the timing might not be ideal right now... Would it be helpful if um, I sent you some information about how we've helped similar businesses in your industry? Then perhaps we could reconnect in [timeframe].\"  \n- For unqualified leads: \"Based on what you've shared, it sounds like our solutions might not be the best fit for your current needs. We typically work best with companies that [ideal customer profile]. To be respectful of your time, I won't suggest moving forward, but if your situation changes, especially regarding [qualifying factor], please reach out.\"\n\n[Closing]  \nEnd with: \"Thank you for taking the time to chat today. [Personalized closing based on outcome]. Ah, have a great day!\"\n\n[Response Guidelines]  \n- Keep initial responses under 30 words, expanding only when providing valuable information.  \n- Ask one question at a time, allowing the prospect to fully respond.  \n- Acknowledge and reference prospect's previous answers to show active listening.  \n- Use affirming language: \"That's a great point,\" \"I understand exactly what you mean.\"\n\n[Scenario Handling]  \n\n- [For Interested But Busy Prospects]: Acknowledge their time constraints: \"I understand you're pressed for time.\" Offer flexibility: \"Would it be better to, um, schedule a specific time for us to talk?\"  \n- [For Skeptical Prospects]: Acknowledge skepticism: \"I understand you might be hesitant, and that's completely reasonable.\" Address objections specifically: \"That's a common concern. Here's how we typically address that...\"  \n- [For Information Gatherers]: Identify their stage: \"Are you actively evaluating solutions now, or just beginning to explore options?\" Provide valuable insights: \"One thing many businesses in your position don't initially consider is...\"  \n- [For Unqualified Prospects]: Recognize the mismatch honestly: \"Based on what you've shared, I don't think we'd be the right solution for you at this time.\"\n\n[Knowledge Base]  \n\n- Eburon Tech offers three core solutions: OperationsOS (workflow automation), InsightAnalytics (data analysis), and CustomerConnect (client relationship management).  \n- Our solutions are most suitable for mid-market businesses with 50-500 employees.  \n- Implementation typically takes 4-8 weeks depending on customization needs.  \n- Solutions are available in tiered pricing models based on user count and feature requirements.  \n- All solutions include dedicated implementation support and ongoing customer service.\n\n[Response Refinement]  \n- When discussing ROI, use specific examples: \"Companies similar to yours typically see a 30% reduction in processing time within the first three months.\"  \n- For technical questions beyond your knowledge: \"That's an excellent technical question. Our solution architects would be best positioned to give you a comprehensive answer during the next step in our process.\"\n\n[Call Management]  \n- If the conversation goes off-track: \"That's an interesting point about [tangent topic]. To make sure I'm addressing your main business needs, could we circle back to [relevant qualification topic]?\"  \n- If you need clarification: \"Just so I'm understanding correctly, you mentioned [point needing clarification]. Could you elaborate on that a bit more?\"  \n- If technical difficulties occur: \"I apologize for the connection issue. You were telling me about [last clear topic]. Please continue from there.\"`,\n            },\n        ],\n        provider: \"openai\",\n    },\n    firstMessage: \"Hello, this is Stephen from Eburon tech. How is it going?\",\n    firstMessageMode: \"assistant-waits-for-user\",\n    voicemailMessage:\n        \"Hello, this is Stephen from GrowthPartners. I'm calling to discuss how our solutions might help your business operations. I'll try reaching you again, or feel free to call us back at your convenience.\",\n    endCallMessage:\n        \"Thank you for taking the time to discuss your needs with me today. Our team will be in touch with more information soon. Have a great day!\",\n    transcriber: {\n        model: \"gemini-2.0-flash-lite\",\n        language: \"Multilingual\",\n        provider: \"google\",\n    },\n    backgroundSound: \"office\",\n    backgroundDenoisingEnabled: true,\n    analysisPlan: {\n        summaryPlan: { enabled: false },\n        successEvaluationPlan: { enabled: false },\n    },\n    compliancePlan: {\n        hipaaEnabled: false,\n        pciEnabled: false,\n    },\n    isServerUrlSecretSet: false,\n} as const;\n","import { env } from \"@/lib/env\";\nimport { DEFAULT_AGENT, DEFAULT_AGENT_ID } from \"@/lib/defaultAgent\";\n\nconst BASE_URL = \"https://api.vapi.ai\";\n\nexport type ListAssistantsQuery = {\n  limit?: number;\n  createdAtGt?: string;\n  createdAtLt?: string;\n  createdAtGe?: string;\n  createdAtLe?: string;\n  updatedAtGt?: string;\n  updatedAtLt?: string;\n  updatedAtGe?: string;\n  updatedAtLe?: string;\n};\n\nexport class GatewayUpstreamError extends Error {\n  readonly status: number;\n  readonly details: unknown;\n\n  constructor(message: string, status: number, details?: unknown) {\n    super(message);\n    this.status = status;\n    this.details = details;\n  }\n}\n\nfunction requirePrivateToken(): string {\n  const token = env.EV_PRIVATE_TOKEN?.trim();\n  if (!token) {\n    throw new GatewayUpstreamError(\"Gateway private token is not configured.\", 500);\n  }\n  return token;\n}\n\nfunction safeUrl(path: string): string {\n  const url = new URL(path, BASE_URL);\n  if (url.hostname !== \"api.vapi.ai\") {\n    throw new GatewayUpstreamError(\"Outbound host is not allowed.\", 500);\n  }\n  return url.toString();\n}\n\nfunction asBearerAuthorizationHeader(token: string): string {\n  return /^Bearer\\s+/i.test(token) ? token : `Bearer ${token}`;\n}\n\nfunction toPathSegment(value: string): string {\n  return encodeURIComponent(value.trim());\n}\n\nfunction assistantsQueryString(params?: ListAssistantsQuery): string {\n  if (!params) {\n    return \"\";\n  }\n\n  const search = new URLSearchParams();\n  const appendNumber = (key: string, value: number | undefined) => {\n    if (typeof value === \"number\" && Number.isFinite(value)) {\n      search.set(key, String(value));\n    }\n  };\n  const appendString = (key: string, value: string | undefined) => {\n    if (value && value.trim()) {\n      search.set(key, value.trim());\n    }\n  };\n\n  appendNumber(\"limit\", params.limit);\n  appendString(\"createdAtGt\", params.createdAtGt);\n  appendString(\"createdAtLt\", params.createdAtLt);\n  appendString(\"createdAtGe\", params.createdAtGe);\n  appendString(\"createdAtLe\", params.createdAtLe);\n  appendString(\"updatedAtGt\", params.updatedAtGt);\n  appendString(\"updatedAtLt\", params.updatedAtLt);\n  appendString(\"updatedAtGe\", params.updatedAtGe);\n  appendString(\"updatedAtLe\", params.updatedAtLe);\n\n  const query = search.toString();\n  return query ? `?${query}` : \"\";\n}\n\nasync function requestUpstream<T>(path: string, init: RequestInit): Promise<T> {\n  const token = requirePrivateToken();\n\n  const res = await fetch(safeUrl(path), {\n    ...init,\n    headers: {\n      \"Content-Type\": \"application/json\",\n      Authorization: asBearerAuthorizationHeader(token),\n      ...(init.headers ?? {}),\n    },\n    cache: \"no-store\",\n  });\n\n  const text = await res.text();\n  const payload = text ? safeJsonParse(text) : null;\n\n  if (!res.ok) {\n    throw new GatewayUpstreamError(`Upstream request failed for ${path}`, res.status, payload);\n  }\n\n  return payload as T;\n}\n\nfunction safeJsonParse(text: string): unknown {\n  try {\n    return JSON.parse(text);\n  } catch {\n    return { raw: text };\n  }\n}\n\nexport const upstream = {\n  listAssistants: (params?: ListAssistantsQuery) =>\n    requestUpstream<unknown[]>(`/assistant${assistantsQueryString(params)}`, { method: \"GET\" }),\n  getAssistant: (assistantId?: string) => {\n    const id = assistantId ?? env.VAPI_DEFAULT_AGENT_ID ?? DEFAULT_AGENT_ID;\n    return requestUpstream<Record<string, unknown>>(`/assistant/${toPathSegment(id)}`, { method: \"GET\" });\n  },\n  getDefaultAssistant: () => Promise.resolve(DEFAULT_AGENT),\n  createAssistant: (payload: unknown) => requestUpstream<Record<string, unknown>>(\"/assistant\", {\n    method: \"POST\",\n    body: JSON.stringify(payload),\n  }),\n  updateAssistant: (assistantId: string, payload: unknown) =>\n    requestUpstream<Record<string, unknown>>(`/assistant/${toPathSegment(assistantId)}`, {\n      method: \"PATCH\",\n      body: JSON.stringify(payload),\n    }),\n  listCalls: () => requestUpstream<Record<string, unknown>[]>(\"/call\", { method: \"GET\" }),\n  createCall: (payload: unknown) =>\n    requestUpstream<Record<string, unknown>>(\"/call\", {\n      method: \"POST\",\n      body: JSON.stringify(payload),\n    }),\n  listVoicesByProvider: (provider = \"vapi\") =>\n    requestUpstream<unknown>(`/voice-library/${encodeURIComponent(provider)}`, {\n      method: \"GET\",\n    }),\n  listPhoneNumbers: () => requestUpstream<Record<string, unknown>[]>(\"/phone-number\", { method: \"GET\" }),\n  createPhoneNumber: (payload: unknown) =>\n    requestUpstream<Record<string, unknown>>(\"/phone-number\", {\n      method: \"POST\",\n      body: JSON.stringify(payload),\n    }),\n  listCredentials: () => requestUpstream<Record<string, unknown>[]>(\"/credential\", { method: \"GET\" }),\n  getCredential: (credentialId: string) =>\n    requestUpstream<Record<string, unknown>>(`/credential/${toPathSegment(credentialId)}`, {\n      method: \"GET\",\n    }),\n  createCredential: (payload: unknown) =>\n    requestUpstream<Record<string, unknown>>(\"/credential\", {\n      method: \"POST\",\n      body: JSON.stringify(payload),\n    }),\n  updateCredential: (credentialId: string, payload: unknown) =>\n    requestUpstream<Record<string, unknown>>(`/credential/${toPathSegment(credentialId)}`, {\n      method: \"PATCH\",\n      body: JSON.stringify(payload),\n    }),\n  deleteCredential: (credentialId: string) =>\n    requestUpstream<Record<string, unknown> | null>(`/credential/${toPathSegment(credentialId)}`, {\n      method: \"DELETE\",\n    }),\n};\n","import { Prisma, type CallSource } from \"@prisma/client\";\n\nimport { prisma } from \"@/lib/db\";\nimport { backupCallLog as syncCallToSupabase } from \"@/lib/ev/backup\";\n\nexport function parseCallTimestamp(value: unknown): Date | null {\n  if (!value) {\n    return null;\n  }\n\n  if (typeof value === \"string\" || typeof value === \"number\") {\n    const date = new Date(value);\n    if (!Number.isNaN(date.valueOf())) {\n      return date;\n    }\n  }\n\n  return null;\n}\n\nexport function callIdFromUpstream(call: Record<string, unknown>): string {\n  return String(call.id ?? call.callId ?? \"\").trim();\n}\n\nexport async function upsertCallLog(input: {\n  orgId: string;\n  agentId?: string | null;\n  upstreamCall: Record<string, unknown>;\n  source: CallSource;\n}): Promise<void> {\n  const { orgId, agentId, upstreamCall, source } = input;\n  const callId = callIdFromUpstream(upstreamCall);\n\n  if (!callId) {\n    return;\n  }\n\n  const startedAt = parseCallTimestamp(upstreamCall.startedAt);\n  const endedAt = parseCallTimestamp(upstreamCall.endedAt);\n\n  const record = await prisma.callLog.upsert({\n    where: { vapiCallId: callId },\n    update: {\n      agentId: agentId ?? undefined,\n      fromNumber: extractCustomerNumber(upstreamCall.customer),\n      toNumber: asString(upstreamCall.phoneNumberId ?? upstreamCall[\"to\"]),\n      startedAt,\n      endedAt,\n      durationSeconds: asNumber(upstreamCall.durationSeconds ?? upstreamCall.duration),\n      costUsd: asNumber(upstreamCall.cost),\n      status: asString(upstreamCall.status) ?? \"unknown\",\n      direction: asString(upstreamCall.type),\n      transcript: coerceJson(upstreamCall.messages),\n      recordingUrl: asString(upstreamCall.recordingUrl),\n      metadata: coerceJson(upstreamCall),\n      source,\n    },\n    create: {\n      orgId,\n      agentId: agentId ?? null,\n      vapiCallId: callId,\n      fromNumber: extractCustomerNumber(upstreamCall.customer),\n      toNumber: asString(upstreamCall.phoneNumberId ?? upstreamCall[\"to\"]),\n      startedAt,\n      endedAt,\n      durationSeconds: asNumber(upstreamCall.durationSeconds ?? upstreamCall.duration),\n      costUsd: asNumber(upstreamCall.cost),\n      status: asString(upstreamCall.status) ?? \"unknown\",\n      direction: asString(upstreamCall.type),\n      transcript: coerceJson(upstreamCall.messages),\n      recordingUrl: asString(upstreamCall.recordingUrl),\n      metadata: coerceJson(upstreamCall),\n      source,\n    },\n  });\n\n  // Fire-and-forget Supabase backup\n  void syncCallToSupabase(record).catch(() => { });\n}\n\nfunction extractCustomerNumber(value: unknown): string | undefined {\n  if (typeof value === \"string\") {\n    return value;\n  }\n\n  if (typeof value === \"object\" && value) {\n    const record = value as Record<string, unknown>;\n    if (typeof record.number === \"string\") {\n      return record.number;\n    }\n    if (typeof record.phoneNumber === \"string\") {\n      return record.phoneNumber;\n    }\n  }\n\n  return undefined;\n}\n\nfunction asString(value: unknown): string | undefined {\n  return typeof value === \"string\" ? value : undefined;\n}\n\nfunction asNumber(value: unknown): number | undefined {\n  if (typeof value === \"number\") {\n    return value;\n  }\n\n  if (typeof value === \"string\") {\n    const n = Number(value);\n    return Number.isFinite(n) ? n : undefined;\n  }\n\n  return undefined;\n}\n\nfunction coerceJson(value: unknown): Prisma.InputJsonValue | undefined {\n  if (value === null) {\n    return undefined;\n  }\n\n  if (typeof value === \"string\" || typeof value === \"number\" || typeof value === \"boolean\") {\n    return value;\n  }\n\n  if (Array.isArray(value) || typeof value === \"object\") {\n    return value as Prisma.InputJsonValue;\n  }\n\n  return undefined;\n}\n","import type { NextRequest } from \"next/server\";\n\nimport { prisma } from \"@/lib/db\";\nimport { assertProjectEmailAccess, getBearerToken, verifySupabaseIdentityFromToken } from \"@/lib/crm/access\";\n\nexport type AuthorizedCrmContext = {\n  accessToken: string;\n  project: {\n    id: string;\n    orgId: string;\n    name: string;\n    slug: string;\n    customDomain: string | null;\n    description: string | null;\n    allowedEmails: string | null;\n    logoUrl: string | null;\n    isActive: boolean;\n  };\n  identity: {\n    id: string;\n    email: string;\n  };\n};\n\nexport async function authorizeCrmProjectRequest(\n  req: NextRequest,\n  clientSlug: string,\n): Promise<AuthorizedCrmContext> {\n  const token = getBearerToken(req);\n  const identity = await verifySupabaseIdentityFromToken(token);\n\n  const project = await prisma.crmProject.findUnique({\n    where: { slug: clientSlug },\n    select: {\n      id: true,\n      orgId: true,\n      name: true,\n      slug: true,\n      customDomain: true,\n      description: true,\n      allowedEmails: true,\n      logoUrl: true,\n      isActive: true,\n    },\n  });\n\n  if (!project || !project.isActive) {\n    throw Object.assign(new Error(\"CRM project not found or inactive.\"), { status: 404 });\n  }\n\n  assertProjectEmailAccess(project, identity.email);\n  return { accessToken: token, project, identity };\n}\n","import type { NextRequest } from \"next/server\";\n\nimport { createClient, isSupabaseEnabled } from \"@/lib/supabase\";\nimport { getSupabaseAdminClient } from \"@/lib/supabase-server\";\n\ntype ProjectGate = {\n  allowedEmails: string | null;\n};\n\nexport type SupabaseIdentity = {\n  id: string;\n  email: string;\n};\n\nexport function requireSupabaseForCrm(): void {\n  if (!isSupabaseEnabled()) {\n    throw Object.assign(\n      new Error(\n        \"Supabase is required for CRM. Configure NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY.\",\n      ),\n      { status: 500 },\n    );\n  }\n}\n\nexport function getBearerToken(req: NextRequest): string {\n  const header = req.headers.get(\"authorization\") ?? \"\";\n  const [scheme, token] = header.split(/\\s+/, 2);\n  if (!/^Bearer$/i.test(scheme) || !token?.trim()) {\n    throw Object.assign(new Error(\"Missing Authorization Bearer token.\"), { status: 401 });\n  }\n  return token.trim();\n}\n\nexport async function verifySupabaseIdentityFromToken(token: string): Promise<SupabaseIdentity> {\n  requireSupabaseForCrm();\n  const client = getSupabaseAdminClient() ?? createClient();\n  if (!client) {\n    throw Object.assign(new Error(\"Supabase client is unavailable.\"), { status: 500 });\n  }\n\n  const { data, error } = await client.auth.getUser(token);\n  if (error || !data.user) {\n    throw Object.assign(new Error(\"Invalid or expired Supabase session.\"), { status: 401, details: error });\n  }\n\n  const email = data.user.email?.trim().toLowerCase();\n  if (!email) {\n    throw Object.assign(new Error(\"Supabase user email is required for CRM access.\"), { status: 403 });\n  }\n\n  return { id: data.user.id, email };\n}\n\nexport function assertProjectEmailAccess(project: ProjectGate, userEmail: string): void {\n  const raw = project.allowedEmails?.trim();\n  if (!raw) {\n    return;\n  }\n\n  const allowlist = raw\n    .split(\",\")\n    .map((value) => value.trim().toLowerCase())\n    .filter(Boolean);\n\n  if (allowlist.length === 0) {\n    return;\n  }\n\n  if (!allowlist.includes(userEmail.toLowerCase())) {\n    throw Object.assign(new Error(\"Your email is not allowed for this CRM project.\"), { status: 403 });\n  }\n}\n","import { NextResponse } from \"next/server\";\n\nexport function crmOkJson(payload: unknown, status = 200): NextResponse {\n  return NextResponse.json(payload, { status });\n}\n\nexport function crmErrorJson(error: unknown): NextResponse {\n  const anyErr = error as { status?: number; message?: string; details?: unknown };\n  const status = anyErr.status ?? 500;\n  return NextResponse.json(\n    {\n      error: anyErr.message ?? \"Unexpected CRM error.\",\n      details: anyErr.details,\n    },\n    { status },\n  );\n}\n","const CRM_PROJECT_MARKER_PREFIX = \"[crm-project:\";\n\nexport function crmProjectAgentMarker(projectId: string): string {\n  return `${CRM_PROJECT_MARKER_PREFIX}${projectId}]`;\n}\n\nexport function ensureCrmProjectAgentMarker(systemPrompt: string, projectId: string): string {\n  const marker = crmProjectAgentMarker(projectId);\n  const trimmed = systemPrompt.trim();\n  if (trimmed.includes(marker)) {\n    return trimmed;\n  }\n  if (!trimmed) {\n    return marker;\n  }\n  return `${trimmed}\\n\\n${marker}`;\n}\n\n","import { AppRouteRouteModule } from \"next/dist/esm/server/route-modules/app-route/module.compiled\";\nimport { RouteKind } from \"next/dist/esm/server/route-kind\";\nimport { patchFetch as _patchFetch } from \"next/dist/esm/server/lib/patch-fetch\";\nimport { addRequestMeta, getRequestMeta } from \"next/dist/esm/server/request-meta\";\nimport { getTracer, SpanKind } from \"next/dist/esm/server/lib/trace/tracer\";\nimport { setManifestsSingleton } from \"next/dist/esm/server/app-render/manifests-singleton\";\nimport { normalizeAppPath } from \"next/dist/esm/shared/lib/router/utils/app-paths\";\nimport { NodeNextRequest, NodeNextResponse } from \"next/dist/esm/server/base-http/node\";\nimport { NextRequestAdapter, signalFromNodeResponse } from \"next/dist/esm/server/web/spec-extension/adapters/next-request\";\nimport { BaseServerSpan } from \"next/dist/esm/server/lib/trace/constants\";\nimport { getRevalidateReason } from \"next/dist/esm/server/instrumentation/utils\";\nimport { sendResponse } from \"next/dist/esm/server/send-response\";\nimport { fromNodeOutgoingHttpHeaders, toNodeOutgoingHttpHeaders } from \"next/dist/esm/server/web/utils\";\nimport { getCacheControlHeader } from \"next/dist/esm/server/lib/cache-control\";\nimport { INFINITE_CACHE, NEXT_CACHE_TAGS_HEADER } from \"next/dist/esm/lib/constants\";\nimport { NoFallbackError } from \"next/dist/esm/shared/lib/no-fallback-error.external\";\nimport { CachedRouteKind } from \"next/dist/esm/server/response-cache\";\nimport * as userland from \"INNER_APP_ROUTE\";\n// We inject the nextConfigOutput here so that we can use them in the route\n// module.\nconst nextConfigOutput = \"\"\nconst routeModule = new AppRouteRouteModule({\n    definition: {\n        kind: RouteKind.APP_ROUTE,\n        page: \"/api/crm/[clientSlug]/calls/route\",\n        pathname: \"/api/crm/[clientSlug]/calls\",\n        filename: \"route\",\n        bundlePath: \"\"\n    },\n    distDir: process.env.__NEXT_RELATIVE_DIST_DIR || '',\n    relativeProjectDir: process.env.__NEXT_RELATIVE_PROJECT_DIR || '',\n    resolvedPagePath: \"[project]/src/app/api/crm/[clientSlug]/calls/route.ts\",\n    nextConfigOutput,\n    userland\n});\n// Pull out the exports that we need to expose from the module. This should\n// be eliminated when we've moved the other routes to the new format. These\n// are used to hook into the route.\nconst { workAsyncStorage, workUnitAsyncStorage, serverHooks } = routeModule;\nfunction patchFetch() {\n    return _patchFetch({\n        workAsyncStorage,\n        workUnitAsyncStorage\n    });\n}\nexport { routeModule, workAsyncStorage, workUnitAsyncStorage, serverHooks, patchFetch,  };\nexport async function handler(req, res, ctx) {\n    if (routeModule.isDev) {\n        addRequestMeta(req, 'devRequestTimingInternalsEnd', process.hrtime.bigint());\n    }\n    let srcPage = \"/api/crm/[clientSlug]/calls/route\";\n    // turbopack doesn't normalize `/index` in the page name\n    // so we need to to process dynamic routes properly\n    // TODO: fix turbopack providing differing value from webpack\n    if (process.env.TURBOPACK) {\n        srcPage = srcPage.replace(/\\/index$/, '') || '/';\n    } else if (srcPage === '/index') {\n        // we always normalize /index specifically\n        srcPage = '/';\n    }\n    const multiZoneDraftMode = process.env.__NEXT_MULTI_ZONE_DRAFT_MODE;\n    const prepareResult = await routeModule.prepare(req, res, {\n        srcPage,\n        multiZoneDraftMode\n    });\n    if (!prepareResult) {\n        res.statusCode = 400;\n        res.end('Bad Request');\n        ctx.waitUntil == null ? void 0 : ctx.waitUntil.call(ctx, Promise.resolve());\n        return null;\n    }\n    const { buildId, params, nextConfig, parsedUrl, isDraftMode, prerenderManifest, routerServerContext, isOnDemandRevalidate, revalidateOnlyGenerated, resolvedPathname, clientReferenceManifest, serverActionsManifest } = prepareResult;\n    const normalizedSrcPage = normalizeAppPath(srcPage);\n    let isIsr = Boolean(prerenderManifest.dynamicRoutes[normalizedSrcPage] || prerenderManifest.routes[resolvedPathname]);\n    const render404 = async ()=>{\n        // TODO: should route-module itself handle rendering the 404\n        if (routerServerContext == null ? void 0 : routerServerContext.render404) {\n            await routerServerContext.render404(req, res, parsedUrl, false);\n        } else {\n            res.end('This page could not be found');\n        }\n        return null;\n    };\n    if (isIsr && !isDraftMode) {\n        const isPrerendered = Boolean(prerenderManifest.routes[resolvedPathname]);\n        const prerenderInfo = prerenderManifest.dynamicRoutes[normalizedSrcPage];\n        if (prerenderInfo) {\n            if (prerenderInfo.fallback === false && !isPrerendered) {\n                if (nextConfig.experimental.adapterPath) {\n                    return await render404();\n                }\n                throw new NoFallbackError();\n            }\n        }\n    }\n    let cacheKey = null;\n    if (isIsr && !routeModule.isDev && !isDraftMode) {\n        cacheKey = resolvedPathname;\n        // ensure /index and / is normalized to one key\n        cacheKey = cacheKey === '/index' ? '/' : cacheKey;\n    }\n    const supportsDynamicResponse = // If we're in development, we always support dynamic HTML\n    routeModule.isDev === true || // If this is not SSG or does not have static paths, then it supports\n    // dynamic HTML.\n    !isIsr;\n    // This is a revalidation request if the request is for a static\n    // page and it is not being resumed from a postponed render and\n    // it is not a dynamic RSC request then it is a revalidation\n    // request.\n    const isStaticGeneration = isIsr && !supportsDynamicResponse;\n    // Before rendering (which initializes component tree modules), we have to\n    // set the reference manifests to our global store so Server Action's\n    // encryption util can access to them at the top level of the page module.\n    if (serverActionsManifest && clientReferenceManifest) {\n        setManifestsSingleton({\n            page: srcPage,\n            clientReferenceManifest,\n            serverActionsManifest\n        });\n    }\n    const method = req.method || 'GET';\n    const tracer = getTracer();\n    const activeSpan = tracer.getActiveScopeSpan();\n    const context = {\n        params,\n        prerenderManifest,\n        renderOpts: {\n            experimental: {\n                authInterrupts: Boolean(nextConfig.experimental.authInterrupts)\n            },\n            cacheComponents: Boolean(nextConfig.cacheComponents),\n            supportsDynamicResponse,\n            incrementalCache: getRequestMeta(req, 'incrementalCache'),\n            cacheLifeProfiles: nextConfig.cacheLife,\n            waitUntil: ctx.waitUntil,\n            onClose: (cb)=>{\n                res.on('close', cb);\n            },\n            onAfterTaskError: undefined,\n            onInstrumentationRequestError: (error, _request, errorContext, silenceLog)=>routeModule.onRequestError(req, error, errorContext, silenceLog, routerServerContext)\n        },\n        sharedContext: {\n            buildId\n        }\n    };\n    const nodeNextReq = new NodeNextRequest(req);\n    const nodeNextRes = new NodeNextResponse(res);\n    const nextReq = NextRequestAdapter.fromNodeNextRequest(nodeNextReq, signalFromNodeResponse(res));\n    try {\n        const invokeRouteModule = async (span)=>{\n            return routeModule.handle(nextReq, context).finally(()=>{\n                if (!span) return;\n                span.setAttributes({\n                    'http.status_code': res.statusCode,\n                    'next.rsc': false\n                });\n                const rootSpanAttributes = tracer.getRootSpanAttributes();\n                // We were unable to get attributes, probably OTEL is not enabled\n                if (!rootSpanAttributes) {\n                    return;\n                }\n                if (rootSpanAttributes.get('next.span_type') !== BaseServerSpan.handleRequest) {\n                    console.warn(`Unexpected root span type '${rootSpanAttributes.get('next.span_type')}'. Please report this Next.js issue https://github.com/vercel/next.js`);\n                    return;\n                }\n                const route = rootSpanAttributes.get('next.route');\n                if (route) {\n                    const name = `${method} ${route}`;\n                    span.setAttributes({\n                        'next.route': route,\n                        'http.route': route,\n                        'next.span_name': name\n                    });\n                    span.updateName(name);\n                } else {\n                    span.updateName(`${method} ${srcPage}`);\n                }\n            });\n        };\n        const isMinimalMode = Boolean(process.env.MINIMAL_MODE || getRequestMeta(req, 'minimalMode'));\n        const handleResponse = async (currentSpan)=>{\n            var _cacheEntry_value;\n            const responseGenerator = async ({ previousCacheEntry })=>{\n                try {\n                    if (!isMinimalMode && isOnDemandRevalidate && revalidateOnlyGenerated && !previousCacheEntry) {\n                        res.statusCode = 404;\n                        // on-demand revalidate always sets this header\n                        res.setHeader('x-nextjs-cache', 'REVALIDATED');\n                        res.end('This page could not be found');\n                        return null;\n                    }\n                    const response = await invokeRouteModule(currentSpan);\n                    req.fetchMetrics = context.renderOpts.fetchMetrics;\n                    let pendingWaitUntil = context.renderOpts.pendingWaitUntil;\n                    // Attempt using provided waitUntil if available\n                    // if it's not we fallback to sendResponse's handling\n                    if (pendingWaitUntil) {\n                        if (ctx.waitUntil) {\n                            ctx.waitUntil(pendingWaitUntil);\n                            pendingWaitUntil = undefined;\n                        }\n                    }\n                    const cacheTags = context.renderOpts.collectedTags;\n                    // If the request is for a static response, we can cache it so long\n                    // as it's not edge.\n                    if (isIsr) {\n                        const blob = await response.blob();\n                        // Copy the headers from the response.\n                        const headers = toNodeOutgoingHttpHeaders(response.headers);\n                        if (cacheTags) {\n                            headers[NEXT_CACHE_TAGS_HEADER] = cacheTags;\n                        }\n                        if (!headers['content-type'] && blob.type) {\n                            headers['content-type'] = blob.type;\n                        }\n                        const revalidate = typeof context.renderOpts.collectedRevalidate === 'undefined' || context.renderOpts.collectedRevalidate >= INFINITE_CACHE ? false : context.renderOpts.collectedRevalidate;\n                        const expire = typeof context.renderOpts.collectedExpire === 'undefined' || context.renderOpts.collectedExpire >= INFINITE_CACHE ? undefined : context.renderOpts.collectedExpire;\n                        // Create the cache entry for the response.\n                        const cacheEntry = {\n                            value: {\n                                kind: CachedRouteKind.APP_ROUTE,\n                                status: response.status,\n                                body: Buffer.from(await blob.arrayBuffer()),\n                                headers\n                            },\n                            cacheControl: {\n                                revalidate,\n                                expire\n                            }\n                        };\n                        return cacheEntry;\n                    } else {\n                        // send response without caching if not ISR\n                        await sendResponse(nodeNextReq, nodeNextRes, response, context.renderOpts.pendingWaitUntil);\n                        return null;\n                    }\n                } catch (err) {\n                    // if this is a background revalidate we need to report\n                    // the request error here as it won't be bubbled\n                    if (previousCacheEntry == null ? void 0 : previousCacheEntry.isStale) {\n                        const silenceLog = false;\n                        await routeModule.onRequestError(req, err, {\n                            routerKind: 'App Router',\n                            routePath: srcPage,\n                            routeType: 'route',\n                            revalidateReason: getRevalidateReason({\n                                isStaticGeneration,\n                                isOnDemandRevalidate\n                            })\n                        }, silenceLog, routerServerContext);\n                    }\n                    throw err;\n                }\n            };\n            const cacheEntry = await routeModule.handleResponse({\n                req,\n                nextConfig,\n                cacheKey,\n                routeKind: RouteKind.APP_ROUTE,\n                isFallback: false,\n                prerenderManifest,\n                isRoutePPREnabled: false,\n                isOnDemandRevalidate,\n                revalidateOnlyGenerated,\n                responseGenerator,\n                waitUntil: ctx.waitUntil,\n                isMinimalMode\n            });\n            // we don't create a cacheEntry for ISR\n            if (!isIsr) {\n                return null;\n            }\n            if ((cacheEntry == null ? void 0 : (_cacheEntry_value = cacheEntry.value) == null ? void 0 : _cacheEntry_value.kind) !== CachedRouteKind.APP_ROUTE) {\n                var _cacheEntry_value1;\n                throw Object.defineProperty(new Error(`Invariant: app-route received invalid cache entry ${cacheEntry == null ? void 0 : (_cacheEntry_value1 = cacheEntry.value) == null ? void 0 : _cacheEntry_value1.kind}`), \"__NEXT_ERROR_CODE\", {\n                    value: \"E701\",\n                    enumerable: false,\n                    configurable: true\n                });\n            }\n            if (!isMinimalMode) {\n                res.setHeader('x-nextjs-cache', isOnDemandRevalidate ? 'REVALIDATED' : cacheEntry.isMiss ? 'MISS' : cacheEntry.isStale ? 'STALE' : 'HIT');\n            }\n            // Draft mode should never be cached\n            if (isDraftMode) {\n                res.setHeader('Cache-Control', 'private, no-cache, no-store, max-age=0, must-revalidate');\n            }\n            const headers = fromNodeOutgoingHttpHeaders(cacheEntry.value.headers);\n            if (!(isMinimalMode && isIsr)) {\n                headers.delete(NEXT_CACHE_TAGS_HEADER);\n            }\n            // If cache control is already set on the response we don't\n            // override it to allow users to customize it via next.config\n            if (cacheEntry.cacheControl && !res.getHeader('Cache-Control') && !headers.get('Cache-Control')) {\n                headers.set('Cache-Control', getCacheControlHeader(cacheEntry.cacheControl));\n            }\n            await sendResponse(nodeNextReq, nodeNextRes, // @ts-expect-error - Argument of type 'Buffer<ArrayBufferLike>' is not assignable to parameter of type 'BodyInit | null | undefined'.\n            new Response(cacheEntry.value.body, {\n                headers,\n                status: cacheEntry.value.status || 200\n            }));\n            return null;\n        };\n        // TODO: activeSpan code path is for when wrapped by\n        // next-server can be removed when this is no longer used\n        if (activeSpan) {\n            await handleResponse(activeSpan);\n        } else {\n            await tracer.withPropagatedContext(req.headers, ()=>tracer.trace(BaseServerSpan.handleRequest, {\n                    spanName: `${method} ${srcPage}`,\n                    kind: SpanKind.SERVER,\n                    attributes: {\n                        'http.method': method,\n                        'http.target': req.url\n                    }\n                }, handleResponse));\n        }\n    } catch (err) {\n        if (!(err instanceof NoFallbackError)) {\n            const silenceLog = false;\n            await routeModule.onRequestError(req, err, {\n                routerKind: 'App Router',\n                routePath: normalizedSrcPage,\n                routeType: 'route',\n                revalidateReason: getRevalidateReason({\n                    isStaticGeneration,\n                    isOnDemandRevalidate\n                })\n            }, silenceLog, routerServerContext);\n        }\n        // rethrow so that we can handle serving error page\n        // If this is during static generation, throw the error again.\n        if (isIsr) throw err;\n        // Otherwise, send a 500 response.\n        await sendResponse(nodeNextReq, nodeNextRes, new Response(null, {\n            status: 500\n        }));\n        return null;\n    }\n}\n\n//# sourceMappingURL=app-route.js.map\n","import { NextRequest } from \"next/server\";\nimport { Prisma } from \"@prisma/client\";\n\nimport { prisma } from \"@/lib/db\";\nimport { authorizeCrmProjectRequest } from \"@/lib/crm/api\";\nimport { crmProjectAgentMarker } from \"@/lib/crm/agent-scope\";\nimport { crmErrorJson, crmOkJson } from \"@/lib/crm/http\";\nimport { upsertCallLog } from \"@/lib/ev/calls\";\nimport { upstream } from \"@/lib/ev/vapi-client\";\n\nexport const dynamic = \"force-dynamic\";\n\nfunction asRecord(value: unknown): Record<string, unknown> | null {\n  if (!value || typeof value !== \"object\" || Array.isArray(value)) {\n    return null;\n  }\n  return value as Record<string, unknown>;\n}\n\nfunction callAgentIdFromMetadata(call: Record<string, unknown>): string | null {\n  const metadata = asRecord(call.metadata);\n  if (!metadata) {\n    return null;\n  }\n  return typeof metadata.agentId === \"string\" ? metadata.agentId : null;\n}\n\nfunction serializeCall(call: {\n  id: string;\n  vapiCallId: string;\n  status: string;\n  fromNumber: string | null;\n  toNumber: string | null;\n  durationSeconds: number | null;\n  costUsd: number | null;\n  startedAt: Date | null;\n  recordingUrl: string | null;\n  agent: { id: string; name: string } | null;\n}) {\n  return {\n    id: call.id,\n    vapiCallId: call.vapiCallId,\n    status: call.status,\n    fromNumber: call.fromNumber,\n    toNumber: call.toNumber,\n    durationSeconds: call.durationSeconds,\n    costUsd: call.costUsd,\n    startedAt: call.startedAt?.toISOString() ?? null,\n    recordingUrl: call.recordingUrl,\n    agent: call.agent,\n  };\n}\n\nexport async function GET(req: NextRequest, context: { params: Promise<{ clientSlug: string }> }) {\n  try {\n    const { clientSlug } = await context.params;\n    const { project } = await authorizeCrmProjectRequest(req, clientSlug);\n    const marker = crmProjectAgentMarker(project.id);\n    const sync = req.nextUrl.searchParams.get(\"sync\") === \"true\";\n    const query = req.nextUrl.searchParams.get(\"q\")?.trim();\n    const statusFilter = req.nextUrl.searchParams.get(\"status\")?.trim();\n\n    const projectAgents = await prisma.agent.findMany({\n      where: {\n        orgId: project.orgId,\n        systemPrompt: { contains: marker },\n      },\n      select: {\n        id: true,\n      },\n    });\n    const projectAgentIds = projectAgents.map((agent) => agent.id);\n    const projectNumbers = projectAgentIds.length\n      ? await prisma.phoneNumber.findMany({\n          where: {\n            orgId: project.orgId,\n            assignedAgentId: {\n              in: projectAgentIds,\n            },\n          },\n          select: {\n            displayNumber: true,\n            vapiPhoneNumberId: true,\n          },\n        })\n      : [];\n    const projectPhoneKeys = Array.from(\n      new Set(\n        projectNumbers\n          .flatMap((num) => [num.displayNumber, num.vapiPhoneNumberId])\n          .filter((value): value is string => typeof value === \"string\" && value.trim().length > 0),\n      ),\n    );\n\n    if (sync) {\n      const upstreamCalls = await upstream.listCalls();\n      await Promise.all(\n        upstreamCalls.map((upstreamCall) =>\n          upsertCallLog({\n            orgId: project.orgId,\n            agentId: callAgentIdFromMetadata(upstreamCall),\n            upstreamCall,\n            source: \"sync\",\n          }),\n        ),\n      );\n    }\n\n    if (!projectAgentIds.length && !projectPhoneKeys.length) {\n      return crmOkJson({ calls: [] });\n    }\n\n    const visibilityScope: Prisma.CallLogWhereInput = {\n      OR: [\n        ...(projectAgentIds.length\n          ? [\n              {\n                agentId: {\n                  in: projectAgentIds,\n                },\n              },\n            ]\n          : []),\n        ...(projectPhoneKeys.length\n          ? [\n              {\n                AND: [\n                  { agentId: null },\n                  {\n                    toNumber: {\n                      in: projectPhoneKeys,\n                    },\n                  },\n                ],\n              },\n            ]\n          : []),\n      ],\n    };\n\n    const whereClauses: Prisma.CallLogWhereInput[] = [visibilityScope];\n    if (statusFilter) {\n      whereClauses.push({ status: statusFilter });\n    }\n    if (query) {\n      whereClauses.push({\n        OR: [\n          { fromNumber: { contains: query } },\n          { toNumber: { contains: query } },\n          { vapiCallId: { contains: query } },\n        ],\n      });\n    }\n\n    const calls = await prisma.callLog.findMany({\n      where: {\n        orgId: project.orgId,\n        AND: whereClauses,\n      },\n      include: {\n        agent: {\n          select: {\n            id: true,\n            name: true,\n          },\n        },\n      },\n      orderBy: { startedAt: \"desc\" },\n      take: 250,\n    });\n\n    return crmOkJson({\n      calls: calls.map(serializeCall),\n    });\n  } catch (error) {\n    return crmErrorJson(error);\n  }\n}\n"],"names":[],"mappings":"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","ignoreList":[8]}